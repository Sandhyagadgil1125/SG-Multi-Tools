                [array[i], array[j]] = [array[j], array[i]];
            }
            return array.join('');
        }
        
        // Update password strength indicator
        function updateStrength(password) {
            let score = 0;
            
            // Length check
            if (password.length >= 8) score += 1;
            if (password.length >= 12) score += 1;
            if (password.length >= 16) score += 1;
            if (password.length >= 20) score += 1;
            
            // Character variety checks
            if (/[A-Z]/.test(password)) score += 1;
            if (/[a-z]/.test(password)) score += 1;
            if (/[0-9]/.test(password)) score += 1;
            if (/[^A-Za-z0-9]/.test(password)) score += 1;
            
            // Additional checks for strong passwords
            if (/[A-Z].*[A-Z]/.test(password)) score += 0.5; // Multiple uppercase
            if (/[a-z].*[a-z]/.test(password)) score += 0.5; // Multiple lowercase
            if (/[0-9].*[0-9]/.test(password)) score += 0.5; // Multiple numbers
            if (/[^A-Za-z0-9].*[^A-Za-z0-9]/.test(password)) score += 0.5; // Multiple symbols
            
            // Penalty for repeating patterns
            if (/(.)\1{2,}/.test(password)) score -= 1;
            
            // Normalize score to 0-100
            const normalizedScore = Math.min(100, Math.max(0, (score / 8) * 100));
            
            // Update strength bar
            strengthBar.style.width = normalizedScore + '%';
            
            // Update strength label and color
            if (normalizedScore < 25) {
                strengthLabel.textContent = 'Very Weak';
                strengthBar.style.background = '#ff4d4d';
                strengthIcon.className = 'fas fa-shield-alt';
                strengthIcon.style.color = '#ff4d4d';
            } else if (normalizedScore < 45) {
                strengthLabel.textContent = 'Weak';
                strengthBar.style.background = '#ff8c4d';
                strengthIcon.className = 'fas fa-shield';
                strengthIcon.style.color = '#ff8c4d';
            } else if (normalizedScore < 65) {
                strengthLabel.textContent = 'Fair';
                strengthBar.style.background = '#ffd24d';
                strengthIcon.className = 'fas fa-shield';
                strengthIcon.style.color = '#ffd24d';
            } else if (normalizedScore < 85) {
                strengthLabel.textContent = 'Good';
                strengthBar.style.background = '#8cff4d';
                strengthIcon.className = 'fas fa-shield';
                strengthIcon.style.color = '#8cff4d';
            } else {
                strengthLabel.textContent = 'Strong';
                strengthBar.style.background = '#42f8f5';
                strengthIcon.className = 'fas fa-shield';
                strengthIcon.style.color = '#42f8f5';
            }
        }
        
        // Calculate entropy
        function calculateEntropy(password, chars) {
            if (!password) return;
            
            // Calculate pool size
            let poolSize = 0;
            if (useUppercase.checked) poolSize += 26;
            if (useLowercase.checked) poolSize += 26;
            if (useNumbers.checked) poolSize += 10;
            if (useSymbols.checked) poolSize += CHAR_SETS.symbols.length;
            
            // Adjust for exclusions
            if (excludeAmbiguous.checked) poolSize -= AMBIGUOUS_CHARS.length;
            if (excludeChars.value.trim()) {
                poolSize -= excludeChars.value.length;
            }
            
            // Calculate entropy: log2(poolSize^length)
            const entropy = Math.log2(Math.pow(poolSize, password.length));
            
            // Update entropy display
            entropyValue.textContent = entropy.toFixed(1);
            
            // Update entropy description
            if (entropy < 30) {
                entropyDescription.textContent = 'Very weak - Can be cracked instantly';
            } else if (entropy < 50) {
                entropyDescription.textContent = 'Weak - May take hours to crack';
            } else if (entropy < 70) {
                entropyDescription.textContent = 'Fair - Could take months to crack';
            } else if (entropy < 90) {
                entropyDescription.textContent = 'Good - Would take centuries to crack';
            } else {
                entropyDescription.textContent = 'Excellent - Virtually uncrackable';
            }
        }
        
        // Copy password to clipboard
        function copyPassword() {
            if (!passwordOutput.value) {
                alert('No password to copy');
                return;
            }
            
            navigator.clipboard.writeText(passwordOutput.value).then(() => {
                // Visual feedback
                const copyBtn = document.querySelector('.password-action-btn[title="Copy to Clipboard"]');
                const originalHTML = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                copyBtn.style.color = '#42f8f5';
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalHTML;
                    copyBtn.style.color = '';
                }, 2000);
            }).catch(() => {
                alert('Failed to copy password');
            });
        }
        
        // Initialize event listeners
        function initEventListeners() {
            // Regenerate on checkbox change
            const checkboxes = [
                useUppercase, useLowercase, useNumbers, useSymbols,
                excludeAmbiguous, avoidRepeating, requireEveryType
            ];
            
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', generatePassword);
            });
            
            // Regenerate on exclude chars input (with debounce)
            let excludeTimeout;
            excludeChars.addEventListener('input', function() {
                clearTimeout(excludeTimeout);
                excludeTimeout = setTimeout(generatePassword, 300);
            });
            
            // Generate initial password
            generatePassword();
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadHistory();
            initEventListeners();
            
            // Set initial length value
            lengthValue.textContent = passwordLength.value;
        });
        
        // Export functions for onclick handlers
        window.generatePassword = generatePassword;
        window.regeneratePassword = regeneratePassword;
        window.copyPassword = copyPassword;
        window.clearHistory = clearHistory;
        window.copyHistoryPassword = copyHistoryPassword;
    </script>
</body>
</html>
